#############################################################################################################
### CONFIGURATION GENERATED BY THE RATOS CONFIGURATOR
### Everything below [include RatOS.cfg] will override default RatOS behavior
#############################################################################################################
[include RatOS.cfg]

#############################################################################################################
### MACRO CONFIGURATION
### Configure the behavior of RatOS macros
### See: https://os.ratrig.com/docs/configuration/macros
#############################################################################################################
[gcode_macro RatOS]
variable_relative_extrusion: True
variable_preheat_extruder: True
variable_calibrate_bed_mesh: True
variable_nozzle_priming: "primeblob"
variable_start_print_park_in: "back"
variable_start_print_park_z_height: 50
variable_end_print_park_in: "back"
variable_pause_print_park_in: "back"
variable_bed_heat_soak_time: 1200
variable_hotend_heat_soak_time: 300
variable_start_print_park_in: 'primeblob'

#############################################################################################################
### USER OVERRIDES & CUSTOM CONFIGURATION
### Anything custom you want to add, or RatOS configuration you want to override, do it here.
### This section is pre-populated with the most common settings you may want to change.
### See: https://os.ratrig.com/docs/configuration/includes-and-overrides
###
### It is recommended that you follow these steps to properly calibrate your printer:
### 0) Sanity check and PID Tuning: https://www.klipper3d.org/Config_checks.html
### 1) Z-offset calibration: run BEACON_RATOS_CALIBRATE to automatically calibrate your beacon for scan and contact.
###    IMPORTANT: Ensure the beacon is properly mounted and the nozzle and meltzone is clean by unloading
###    the filament (if it's loaded) and make sure there's no ooze or gunk on the nozzle when the hotend is at printing temperature.
### 2) Pressure Advance: https://www.klipper3d.org/Pressure_Advance.html
### 3) Skew Correction: https://www.klipper3d.org/Skew_Correction.html
### 4) Resonance Compensation: https://www.klipper3d.org/Resonance_Compensation.html
### RatOS has dedicated macro's to generate shaper graphs for deeper analysis (requires accelerometer).
### Use MEASURE_COREXY_BELT_TENSION to compare tension between belts, and use
### GENERATE_SHAPER_GRAPHS to generate the resonance graphs for analysing and manually entering input shaper
### configuration.
### You can run SHAPER_CALIBRATE to automatically calibrate your input shaper configuration, if you just want
### to get started.
### Additionally, you can use the Realtime Analysis Tool to analyze your printer's performance in real-time.
### Read more about klipper here: https://www.klipper3d.org/Overview.html
#############################################################################################################

#---------------------------------------------------- X -----------------------------------------------------
# The X axis motor for the left toolhead, located at the rear left of the printer
#------------------------------------------------------------------------------------------------------------
[stepper_x]
dir_pin: x_dir_pin                # Add ! in front of pin name to reverse the direction of stepper_x
rotation_distance: 40             # 40 for 20 tooth 2GT pulleys, 32 for 16 tooth 2GT pulleys
homing_speed: 50
position_min: -59.8
position_max: 400
position_endstop: -59.8

#---------------------------------------------- DUAL_CARRIAGE -----------------------------------------------
# The X axis motor for the right toolhead, located at the rear right of the printer
#------------------------------------------------------------------------------------------------------------
[dual_carriage]
dir_pin: dual_carriage_dir_pin    # Add ! in front of pin name to reverse the direction of dual_carriage
rotation_distance: 40             # 40 for 20 tooth 2GT pulleys, 32 for 16 tooth 2GT pulleys
position_min: 0
position_max: 459.8
position_endstop: 459.8
safe_distance: 55

#---------------------------------------------------- Y -----------------------------------------------------
# The left Y motor used for cartesian Y control in Hybrid CoreXY, located at the rear left of the printer
#------------------------------------------------------------------------------------------------------------
[stepper_y]
dir_pin: !y_dir_pin               # Remove ! in front of pin name to reverse the direction of stepper_y
rotation_distance: 40             # 40 for 20 tooth 2GT pulleys, 32 for 16 tooth 2GT pulleys
homing_speed: 50
position_min: -14.35
position_max: 433.65
position_endstop: -14.35

#---------------------------------------------------- Y1 ----------------------------------------------------
# The right Y motor used for cartesian Y control in Hybrid CoreXY, located at the rear right of the printer
#------------------------------------------------------------------------------------------------------------
[stepper_y1]
dir_pin: y1_dir_pin               # Add ! in front of pin name to reverse the direction of stepper_y1
rotation_distance: 40             # 40 for 20 tooth 2GT pulleys, 32 for 16 tooth 2GT pulleys

#---------------------------------------------------- Z -----------------------------------------------------
# The left Z motor for the kinematic bed
#------------------------------------------------------------------------------------------------------------
[stepper_z]
dir_pin: !z0_dir_pin              # Remove ! in front of pin name to reverse the direction of stepper_z
rotation_distance: 4              # 4 for TR8*4 lead screws
homing_speed: 10
position_min: -7
position_max: 400

#---------------------------------------------------- Z1 ----------------------------------------------------
# The rear Z motor for the kinematic bed
#------------------------------------------------------------------------------------------------------------
[stepper_z1]
dir_pin: !z1_dir_pin              # Remove ! in front of pin name to reverse the direction of stepper_z1
rotation_distance: 4              # 4 for TR8*4 lead screws

#---------------------------------------------------- Z2 ----------------------------------------------------
# The right Z motor for the kinematic bed
#------------------------------------------------------------------------------------------------------------
[stepper_z2]
dir_pin: !z2_dir_pin              # Remove ! in front of pin name to reverse the direction of stepper_z2
rotation_distance: 4              # 4 for TR8*4 lead screws

#------------------------------------------------- EXTRUDER -------------------------------------------------
# The extruder motor used for pushing filament through the left toolhead (T0)
#------------------------------------------------------------------------------------------------------------
[extruder]
dir_pin: toolboard_t0:e_dir_pin   # Add ! in front of pin name to reverse the direction of extruder
rotation_distance: 4.63           # Orbiter 2 default
#pressure_advance: 0.05           # Check https://www.klipper3d.org/Pressure_Advance.html for pressure advance tuning.
control: pid
pid_kp: 28.413
pid_ki: 1.334
pid_kd: 151.300

#------------------------------------------------ EXTRUDER1 -------------------------------------------------
# The extruder motor used for pushing filament through the right toolhead (T1)
#------------------------------------------------------------------------------------------------------------
[extruder1]
dir_pin: toolboard_t1:e_dir_pin   # Add ! in front of pin name to reverse the direction of extruder1
rotation_distance: 4.63           # Orbiter 2 default
#pressure_advance: 0.05           # Check https://www.klipper3d.org/Pressure_Advance.html for pressure advance tuning.
control: pid
pid_kp: 28.413
pid_ki: 1.334
pid_kd: 151.300


[heater_bed]
control: pid
pid_Kp: 22.2
pid_Ki: 1.08
pid_Kd: 114

[z_offset_probe]
pin: ^PG10                   # probe trigger pin    
z_offset: -7                   # probe height, used to limit the probe z-move
y_offset: 0                    # probe y-offset, measured from the camera centre
x_offset: 37.5               # probe x-offset, measured from the camera centre
speed: 10                      
samples: 3                    # number of samples  
sample_retract_dist: 10
lift_speed: 10.0
samples_result: median
samples_tolerance: 0.2
samples_tolerance_retries: 5

[neopixel vaoc_led]
pin: PB0
chain_count: 6
color_order: GRB

[heater_fan vaoc_fan]
pin: PD13
heater: heater_bed
fan_speed: 1.0
heater_temp: 50

[stepper_y]
position_max: 434.650

[gcode_macro RatOS]
variable_bed_margin_y: [14.350, 34.650]

[led frontlight]
white_pin: mcu:PB11
hardware_pwm: True
initial_WHITE: 0.5

[controller_fan controller_fan]
fan_speed: 0.75

[dual_carriage]
position_max: 459.486
position_endstop: 459.486

[gcode_macro RatOS]
variable_bed_margin_x: [59.800, 59.486]

[gcode_macro _VAOC]
variable_expected_camera_x_position: 161.096
variable_expected_camera_y_position: 429.031

[gcode_macro T0]
variable_parking_position: -57.800

[gcode_macro T1]
variable_parking_position: 457.486
 
[gcode_macro RatOS]
variable_shaper_x_freq: [54.0, 53.0, 53.5, 53.5]                                   # shaper frequency [T0, T1, COPY, MIRROR]
variable_shaper_y_freq: [55.4, 57.2, 56.3, 56.3]                                   # shaper frequency [T0, T1, COPY, MIRROR]
variable_shaper_x_type: ["mzv", "mzv", "mzv", "mzv"]                   # shaper frequency algorythm [T0, T1, COPY, MIRROR]
variable_shaper_y_type: ["ei", "ei", "ei", "ei"]                   # shaper frequency algorythm [T0, T1, COPY, MIRROR]

[ratos]
allow_unsupported_slicer_versions: True

# REMEMBER TO CALIBRATE YOUR BEACON!
# Run BEACON_RATOS_CALIBRATE for automatic calibration.

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*#
#*# [extruder1]
#*#
#*# [beacon model default]
#*# model_coef = 1.5322057592737945,
#*# 	  1.8599470710857258,
#*# 	  0.7667908103038683,
#*# 	  0.35353428461808706,
#*# 	  0.27927768542125586,
#*# 	  0.26770821292339825,
#*# 	  -0.1173932446443918,
#*# 	  -0.23575530436622422,
#*# 	  0.13994161510806413,
#*# 	  0.1585295654341067
#*# model_domain = 1.88600804771171e-07,1.9411600395210791e-07
#*# model_range = 0.200000,5.000000
#*# model_temp = 42.082950
#*# model_offset = -1.01600
#*#
#*# [bed_mesh ratos]
#*# version = 1
#*# points =
#*# 	  0.286111, 0.284288, 0.286273, 0.280640, 0.277713, 0.275956
#*# 	  0.281917, 0.280736, 0.281493, 0.276433, 0.271648, 0.270904
#*# 	  0.273649, 0.277483, 0.279696, 0.275430, 0.270030, 0.267268
#*# 	  0.272999, 0.271582, 0.273982, 0.267845, 0.262082, 0.257517
#*# 	  0.266582, 0.269252, 0.273130, 0.267834, 0.255589, 0.251189
#*# 	  0.265949, 0.268297, 0.269612, 0.262783, 0.249133, 0.245226
#*# 	  0.261698, 0.264736, 0.265012, 0.258986, 0.246092, 0.238895
#*# 	  0.263205, 0.262807, 0.260133, 0.254564, 0.241713, 0.236621
#*# 	  0.260896, 0.263456, 0.263434, 0.253909, 0.242356, 0.235287
#*# 	  0.263057, 0.260548, 0.258996, 0.250956, 0.238830, 0.233466
#*# 	  0.261378, 0.260038, 0.260232, 0.252033, 0.238914, 0.234429
#*# 	  0.260630, 0.260950, 0.257768, 0.249765, 0.237139, 0.230747
#*# 	  0.257555, 0.258448, 0.258232, 0.251461, 0.238320, 0.232341
#*# 	  0.259519, 0.258628, 0.255464, 0.247801, 0.232868, 0.232099
#*# 	  0.256967, 0.259002, 0.259151, 0.250442, 0.238357, 0.232811
#*# 	  0.259416, 0.260817, 0.258427, 0.248237, 0.237860, 0.229720
#*# 	  0.256584, 0.262109, 0.261533, 0.251075, 0.239928, 0.233655
#*# 	  0.257473, 0.258070, 0.257844, 0.248679, 0.238053, 0.232798
#*# x_count = 6
#*# y_count = 18
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 164.129
#*# max_x = 235.871
#*# min_y = 99.1288
#*# max_y = 300.871
